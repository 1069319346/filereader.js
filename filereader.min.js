/*!
    FileReader.js - a lightweight wrapper for common FileReader usage.
    Copyright 2012 Brian Grinstead - MIT License.
    See http://github.com/bgrins/filereader.js for documentation.
    Built: 2012-05-25 10:05:37 PM
*/

(function(a){function j(a,b){function d(a){var b=[],d=a.clipboardData||{},e=d.items||[];for(var f=0;f<e.length;f++){var g=e[f].getAsFile();if(g){var h=(new RegExp("image/(.*)")).exec(g.type);if(h){var i=h[1];g.name="clipboard"+f+"."+i,b.push(g)}}}b.length&&(o(b,c),a.preventDefault(),a.stopPropagation())}if(!h.enabled)return;var c=r(r({},h.opts),b);a.addEventListener("paste",d,!1)}function k(a,b){function d(a){o(a.target.files,c)}if(!h.enabled)return;var c=r(r({},h.opts),b);a.addEventListener("change",d,!1)}function l(a,b){function f(a){return function(){if(e)return;a.apply(this,arguments)}}function g(a){e=!1}function i(a){e=!0}function j(a){a.dataTransfer.files&&a.dataTransfer.files.length&&(a.stopPropagation(),a.preventDefault())}function k(b){b.stopPropagation(),b.preventDefault(),d&&u(a,d),o(b.dataTransfer.files,c)}function l(b){d&&t(a,d),b.stopPropagation(),b.preventDefault()}function m(b){d&&u(a,d)}function n(b){d&&t(a,d),b.stopPropagation(),b.preventDefault()}if(!h.enabled)return;var c=r(r({},h.opts),b),d=c.dragClass;document.body.addEventListener("dragstart",i,!0),document.body.addEventListener("dragend",g,!0),document.body.addEventListener("drop",j,!1),a.addEventListener("dragenter",f(l),!1),a.addEventListener("dragleave",f(m),!1),a.addEventListener("dragover",f(n),!1),a.addEventListener("drop",f(k),!1);var e=!1}function m(a,b){for(var c=0;c<a.length;c++){var d=a[c];d.extra={nameNoExtension:d.name.substring(0,d.name.lastIndexOf(".")),extension:d.name.substring(d.name.lastIndexOf(".")+1),fileID:c,uniqueID:x(),groupID:b,prettySize:v(d.size)}}}function n(a,b,c){for(var d in b)if(a.match(new RegExp(d)))return"readAs"+b[d];return"readAs"+c}function o(a,c){var d={groupID:w(),files:a,started:new Date};h.output.push(d);var j=a.length,k=function(){--j==0&&(d.ended=new Date,c.on.groupend(d))};m(a,d.groupID),c.on.groupstart(d),a.length||(d.ended=new Date,c.on.groupend(d));var l=h.sync&&e,o;l&&(o=i.getWorker(f,function(a){var b=a.data.file;b.extra||(b.extra=a.data.extra),a.data.result==="error"?c.on.error({},b):c.on.load({target:{result:a.data.result}},b),k()})),Array.prototype.forEach.call(a,function(a){if(c.accept&&!a.type.match(new RegExp(c.accept))){c.on.skip(a),k();return}if(c.on.beforestart(a)===!1){c.on.skip(a),k();return}var d=n(a.type,c.readAsMap,c.readAsDefault);if(l&&o)o.postMessage({file:a,extra:a.extra,readAs:d});else{var e=new b;g.forEach(function(b){e["on"+b]=function(d){c.on[b](d,a),b=="loadend"&&k()}}),e[d](a)}})}function p(){var a=i.getURL("self.addEventListener('message', function(e) { postMessage(!!FileReaderSync); }, false);");if(a){var b=new Worker(a);b.onmessage=function(b){e=b.data,d.revokeObjectURL(a)},b.postMessage()}}function q(){}function r(a,b){for(var c in b)b[c]&&b[c].constructor&&b[c].constructor===Object?(a[c]=a[c]||{},arguments.callee(a[c],b[c])):a[c]=b[c];return a}function s(a,b){return(new RegExp("(?:^|\\s+)"+b+"(?:\\s+|$)")).test(a.className)}function t(a,b){s(a,b)||(a.className=a.className?[a.className,b].join(" "):b)}function u(a,b){if(s(a,b)){var c=a.className;a.className=c.replace(new RegExp("(?:^|\\s+)"+b+"(?:\\s+|$)","g")," ").replace(/^\s\s*/,"").replace(/\s\s*$/,"")}}function v(a){var b=["bytes","kb","MB","GB","TB","PB"],c=Math.floor(Math.log(a)/Math.log(1024));return(a/Math.pow(1024,Math.floor(c))).toFixed(2)+" "+b[c]}var b=a.FileReader,c=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,d=window.URL||window.webkitURL,e=!1,f="self.addEventListener('message', function(e) { var data=e.data; try { var reader = new FileReaderSync; postMessage({ result: reader[data.readAs](data.file), extra: data.extra, file: data.file})} catch(e){ postMessage({ result:'error', extra:data.extra, file:data.file}); } }, false);",g=["loadstart","progress","load","abort","error","loadend"],h=a.FileReaderJS={enabled:!1,setupInput:k,setupDrop:l,setupClipboard:j,sync:!1,opts:{dragClass:"drag",accept:!1,readAsMap:{"image/*":"DataURL","text/*":"Text"},readAsDefault:"BinaryString",on:{loadstart:q,progress:q,load:q,abort:q,error:q,loadend:q,skip:q,groupstart:q,groupend:q,beforestart:q}},output:[]};typeof jQuery!="undefined"&&(jQuery.fn.fileReaderJS=function(a){return this.each(function(){$(this).is("input")?k(this,a):l(this,a)})},jQuery.fn.fileClipboard=function(a){return this.each(function(){j(this,a)})});if(!b)return;var i=function(){function c(c){if(window.Worker&&a&&b){var d=new a;return d.append(c),b.createObjectURL(d.getBlob())}return null}function d(a,b){var d=c(a);if(d){var e=new Worker(d);return e.onmessage=b,e}return null}var a=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,b=window.URL||window.webkitURL;return{getURL:c,getWorker:d}}(),w=function(a){return function(){return a++}}(0),x=function(a){return function(){return a++}}(0);h.enabled=!0,p()})(this);